## Software Requirements Specification (SRS)
### 1. Introduction
#### 1.1 Purpose. 
Requirements for the igmqtt components that 
This project transform seismic event data from SCP-GDS into standardized XML messages as used in ShakeAlert and publish them to MQTT brokers to be used in GFAST. 


#### 1.2 Scope. 
The project works under GDS system. It comprises two main scripts. 

 - filter_igmqtt.py – converts SeisComP event parameters into a formatted XML bulletin.

 - send_igmqtt.py – reads XML bulletin and publishes them to configured MQTT brokers.

#### 1.3 Acronyms
 - SCP: SeisComP
 - GDS: Gempa Dissemination Server
 - MQTT: Message Queuing Telemtry Transport  
 - GFAST: Geodetic First Approximation of Size and Timing

### 2. Overall Description
#### 2.1 Product Perspective
Operates within a SeisComP environment and relies on GDS to be triggered once a earthquake occurs and meet the parameters publication like minimum magnitude. 

Uses external helper libraries like ig_gds_utilities and the Paho MQTT client.

#### 2.2 Product Functions
Parse a single seismic event and produce an event_message XML document with data such as magnitude, coordinates, depth, and time.

Publish bulletin data to  MQTT brokers as specified on the configuration of the plugin on GDS.

#### 2.3 User Classes and Characteristics

 - SCP-GDS : runs the IGMQTT service 
 - MQTT client: GFAST server connected to a MQTT server waiting for seismic information to trigger inversion process. 

#### 2.4 Operating Environment

Linux environment with Python 3 and  SCP-GDS libraries installed.

Network connectivity to target MQTT brokers.

### 3. Specific Requirements
#### 3.1 Functional Requirements for FILTER_IGMQTT.PY

##### FR1.0 – Inicializar servicio de filtrado de eventos sísmicos

Descripción: El sistema debe permitir ejecutar una clase de filtro (igMQTTFilter) como servicio dentro del entorno SeisComP.

Entradas: Evento sísmico en formato SeisComP (EventParameters XML).

Procesos: Inicializa el servicio, configura el logger, y procesa el evento usando el método filter.

Salidas: Resultado del filtro, en este caso un mensaje XML con información del evento.

Actores: Servicio automático de SeisComP (gds_service).

Prioridad: Alta.

##### FR1.1 – Parsear parámetros del evento sísmico

Descripción: El sistema debe extraer y formatear información relevante del evento como magnitud, latitud, longitud, profundidad, tipo, estado, y hora de origen.

Entradas: Objeto EventParameters de SeisComP.

Procesos:

Verifica si existe más de un evento (descarta si es así).

Accede a preferredOrigin y preferredMagnitude.

Calcula local_time, extrae evaluationMode y eventType.

Salidas: Diccionario de evento + XML formateado.

Actores: Servicio automático o módulo dependiente.

Prioridad: Alta.

##### FR1.2 – Generar mensaje XML estructurado para publicación

Descripción: El sistema debe construir un mensaje XML según una estructura estándar definida para intercambio de eventos sísmicos.

Entradas: Diccionario con los campos del evento (ID, magnitud, coordenadas, profundidad, fecha y hora).

Procesos:

Crea nodo raíz <event_message>.

Añade nodo <core_info> con subelementos: mag, lat, lon, depth, orig_time, num_stations, etc.

Aplica formato legible (pretty XML).

Salidas: Cadena XML bien formada.

Actores: Broker MQTT o módulo subsiguiente.

Prioridad: Alta.

##### FR1.3 – Registrar actividad del sistema

Descripción: El sistema debe guardar un log de todas las acciones y errores en un archivo específico del sistema SeisComP.

Entradas: Mensajes generados internamente (inicio, errores, parseos).

Procesos: Uso del módulo logging para escribir en el archivo gds_service_igmqtt.log.

Salidas: Archivo de log actualizado con nivel DEBUG.

Actores: Administrador, desarrollador.

Prioridad: Media.

##### FR1.4 – Manejo de errores al procesar eventos inválidos

Descripción: El sistema debe capturar excepciones al procesar eventos mal formateados o incompletos y evitar caídas del servicio.

Entradas: Evento incompleto o inválido.

Procesos:

Captura de errores con try/except.

Registro del error en el log.

Salidas: Código -1 y entrada en el log.

Actores: Servicio SeisComP.

Prioridad: Alta.

#### 3.2 Functional Requirements for SEND_IGMQTT.PY

##### FR2.0 – Inicializar spooler de envío MQTT

Descripción: El sistema GDS debe inicializar un spooler personalizado que permita procesar eventos y enviarlos mediante MQTT.

Entradas: Ruta de archivo de configuración .ini + contenido de boletín de evento (content).

Procesos:

Carga la configuración general.

Lee el archivo de credenciales MQTT.

Salidas: Instancia del spooler lista para procesar mensajes.

Actores: Módulo gds_service, script externo, o administrador.

Prioridad: Alta.

#####  FR2.1 – Leer archivo de credenciales MQTT

Descripción: El sistema debe leer un archivo JSON que contiene las credenciales y configuración para la conexión MQTT.

Entradas: Ruta al archivo mqtt_auth_file especificada en la configuración.

Procesos:

Abre y lee el archivo.

Convierte el contenido a un diccionario Python.

Salidas: Diccionario con parámetros como broker, port, client_id, username, pass, topic.

Actores: Administrador o spooler.

Prioridad: Alta.

##### FR2.2 – Parsear contenido del boletín sísmico

Descripción: El sistema debe leer el contenido crudo de un evento sísmico y convertirlo en un formato plano (plain) a ser enviado por MQTT.

Entradas: Variable content (string), conteniendo el XML del evento generado por filter_igmqtt.py.

Procesos:

Usar bulletin.Bulletin().read(content).

Acceder a plain (mensaje plano).

Salidas: Texto plano del evento.

Actores: Servicio automatizado.

Prioridad: Alta.

##### FR2.3 – Publicar evento a broker MQTT

Descripción: El sistema debe publicar el evento sísmico procesado al broker MQTT, usando autenticación por usuario y contraseña.

Entradas: Diccionario mqtt_info (credenciales y parámetros), y message en formato string.

Procesos:

Crear cliente MQTT.

Conectarse al broker con username y pass.

Publicar en topic.

Desconectar correctamente.

Salidas: Mensaje publicado al broker, confirmación en log.

Actores: Spooler, broker MQTT.

Prioridad: Alta.

##### FR2.4 – Registrar actividad del sistema y errores

Descripción: El sistema debe guardar todos los pasos, intentos de conexión y errores durante la ejecución del spooler.

Entradas: Mensajes del sistema o excepciones.

Procesos:

Uso de logger.info y logger.debug.

Registro de excepciones con detalle.

Salidas: Entradas en el archivo gds_service_igmqtt.log.

Actores: Operador, desarrollador.

Prioridad: Media.

##### FR2.5 – Notificar errores en direcciones de destino

Descripción: Si una dirección MQTT falla, el sistema debe registrar el error específico con el identificador del destino.

Entradas: Tupla (id_destino, tipo_destino) y la excepción correspondiente.

Procesos:

Invoca addTargetError del spooler base.

Registra en log el error por destino.

Salidas: Registro del error y posible reintento.

Actores: Administrador o sistema automático de retry.

Prioridad: Alta.

#### 3.2 External Interface Requirements
Configuration File: Defines path to authentication credentials and logging parameters.

Authentication JSON: Holds broker details and login credentials keyed by server name.

### 3.3 Non‑functional Requirements
Error Handling: Exceptions during parsing or publishing should be logged and raised for higher-level handling.

Message Format Consistency: All generated XML must be well-formed and pretty-printed for readability.

## 4. Dependencies
SeisComP libraries (seiscomp3.Core, seiscomp3.DataModel).

Paho MQTT client for network communication.

Configuration and authentication files residing in paths accessible via SEISCOMP_ROOT.